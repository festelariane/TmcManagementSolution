@using Tmc.Admin.Models.Customers
@using Tmc.BLL.Contract.Cards;
@using Tmc.Core.Infrastructure;

@model CustomerListModel
@{
    //ViewBag.Title = "List";
    ViewBag.Title = "List";
    var gridPageSize = 10;
}

<h2>List</h2>


<div id="grid-customers"></div>


            <script>
                $(document).ready(function () {
                        dataSource = new kendo.data.DataSource({
                            transport: {
                                read:  {
                                    url: "@Html.Raw(Url.Action("List", "Customer"))",
                                    type: "POST",
                                    dataType: "json"
                                },
                                update: {
                                    url:"@Html.Raw(Url.Action("Edit", "Customer"))",
                                    dataType: "json",
                                    type: "POST"
                                },
                                destroy: {
                                    url:"@Html.Raw(Url.Action("Delete", "Customer"))",
                                    dataType: "json",
                                    type: "POST"
                                },
                                create: {
                                    url:"@Html.Raw(Url.Action("Create", "Customer"))",
                                    dataType: "json",
                                    type: "POST"
                                },
                                parameterMap: function(options, operation) {
                                    if (operation !== "read" && options.models) {
                                        return options.models[0];// {model: kendo.stringify(options.models[0])};
                                    }
                                }
                            },
                            batch: true,
                            pageSize: 20,
                            schema: {
                                data: "Data",
                                total: "Total",
                                errors: "Errors",
                                model: {
                                    id: "Id",
                                    fields: {
                                        Id: { editable: false, type: "string",nullable: true },
                                        CardTypeId: { editable: true },
                                        CardType:{},
                                        UserName: { editable: true},
                                        FullName: { editable: true},
                                        Points: { editable: false},
                                        CreatedOnUtc: { editable: false,type: 'date', format: 'dd/MM/yyyy'},
                                        UpdatedOnUtc: { editable: false,type: 'date', format: 'dd/MM/yyyy'},
                                        LastActivityDateUtc: { editable: false,type: 'date', format: 'dd/MM/yyyy'}
                                    }
                                }
                            },
                            requestEnd: function (e) {
                                if (e.type == "create" || e.type == "update") {
                                    this.read();
                                }
                            }
                        });

                    $("#grid-customers").kendoGrid({
                        dataSource: dataSource,
                        pageable: true,
                        height: 450,
                        toolbar: ["create"],
                        columns: [
                            { field: "UserName", title: "UserName" },
                            { field: "FullName", title: "FullName" },
                            {
                                field: "CardTypeId",
                                title: "CardType",
                                width: 200,
                                editor: cardTypeDropdownEditor,
                                template:"#: CardType.Name #"
                                //template:kendo.template($("#myTemplate").html())
                            },
                            { field: "Points", title: "Points" },
                            { field: "CreatedOnUtc", title: "CreatedOnUtc",format:"{0:dd-MM-yyyy}"  },
                            { field: "UpdatedOnUtc", title: "UpdatedOnUtc" ,format:"{0:dd-MM-yyyy}"},
                            { field: "LastActivityDateUtc", title: "LastActivityDateUtc",format:"{0:dd-MM-yyyy}" },
                            { command: ["edit", "destroy"], title: "&nbsp;", width: "200px" }],
                        editable: "inline",
                        edit:function(e)
                        {
                            if(e.model.isNew())
                            {
                                if(allCardTypes.length > 0)
                                {
                                    e.model.CardTypeId = allCardTypes[0].Id;
                                }
                            }
                            else
                            {
                                $(e.container).find('input[name="UserName"]').attr("readonly", true);
                            }
                        }
                    });
                });




                //Load local datasource - All card types:
                @{
                    var cardTypeBiz = EngineContext.Current.Resolve<ICardTypeBiz>();
                    var allCardTypes = cardTypeBiz.GetAllCardTypes();
                }

                var allCardTypes = [
                    {
                        Id: 0,
                        Name: "-- Please select --"
                    }
                    @for (int i = 0; i < allCardTypes.Count; i++)
                    {
                        <text>,</text>
                        var cardType = allCardTypes[i];
                        <text>
                            {
                                Id: @(cardType.Id),
                                Name: "@cardType.Name"
                            }
                        </text>
                        @*if (i != allCardTypes.Count - 1)
                        {
                                <text>,</text>
                        }*@
                    }
                ];

                function cardTypeDropdownEditor(container, options)
                {
                    //$('<input data-bind="value:"' + options.field + '"/>')
                    $('<input required data-text-field="Name" data-value-field="Id" data-bind="value:CardTypeId"/>')
                        .appendTo(container)
                        .kendoDropDownList(
                        {
                            //dataTextField: "Name",
                            //dataValueField: "Id",
                            autoBind: false,
                            dataSource: allCardTypes
                        });
                }
            </script>
